version: v1.1.0
steps:
  - id: pull-base-image
    cmd: docker pull {{.Values.REGISTRY_FROM_URL}}helloworld:v1
  - id: retag-base-image
    # import the public image to base-artifacts
    # Override the stable tag, 
    # and create a unique tag to enable rollback
    # to a previously working image
    when: ['pull-base-image']
    cmd: docker tag {{.Values.REGISTRY_FROM_URL}}helloworld:v1 {{.Run.Registry}}/helloworld:v1
  - id: retag-base-image-unique-tag
    when: ['retag-base-image']
    cmd: docker tag {{.Values.REGISTRY_FROM_URL}}helloworld:v1 {{.Run.Registry}}/helloworld:v1-{{.Run.ID}}
  - id: push-base-image
    when: ['retag-base-image', 'retag-base-image-unique-tag']
    push: 
    - "{{.Run.Registry}}/helloworld:v1"
    - "{{.Run.Registry}}/helloworld:v1-{{.Run.ID}}"
